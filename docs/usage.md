# Usage

Slips can read the packets directly from the **network interface** of the host machine, and packets and flows from different types of files, including

- Packet capture (pcap)
- Argus binetflow
- Zeek/Bro folder with logs, or logs separately 
- Nfdump flows

It's recommended to use PCAPs.

After Slips was run on the traffic, the Slips output can be analyzed with Kalipso GUI interface. In this section, we will explain how to execute each type of file in Slips, and the output can be analyzed with Kalipso.

Either you are [running Slips in docker](https://stratospherelinuxips.readthedocs.io/en/develop/installation.html#installing-and-running-slips-inside-a-docker) or [locally](https://stratospherelinuxips.readthedocs.io/en/develop/installation.html#installing-slips-in-your-own-computer), you can run Slips using the same below commands and configurations.
	

## Reading the input

The table below shows the commands Slips uses for different inputs. The first part of the command **./slips.py -c slips.conf** is same, the second part changes depending on the input type. Also, the user can execute **./slips.py --help** to find correct argument to run Slips on each type of the file.

<style>
table {
  font-family: arial, sans-serif;
  border-collapse: collapse;
  width: 100%;
}

td, th {
  border: 1px solid #dddddd;
  text-align: left;
  padding: 8px;
}

tr:nth-child(even) {
  background-color: #dddddd;
}
</style>



<table>
	<tr>
		<th>File/interface</th>
		<th>Slips Argument</th>
		<th>Example command</th>
	</tr>
	<tr>
		<td>Network interface (*)</td>
		<td>-i</td>
		<td>./slips.py -c slips.conf -i en0</td>
	</tr>
	<tr>
		<td>pcap</td>
		<td>-f</td>
		<td>./slips.py -c slips.conf -f test.pcap</td>
	</tr>
	<tr>
		<td>Argus binetflow</td>
		<td>-f</td>
		<td>./slips.py -c slips.conf -f test.binetflow</td>
	</tr>
	<tr>
		<td>Zeek/Bro folder/log</td>
		<td>-f</td>
		<td>./slips.py -c slips.conf -f zeek_files</td>
	</tr>
	<tr>
		<td>Nfdump flow</td>
		<td>-f</td>
		<td>./slips.py -c slips.conf -f test.nfdump </td>
	</tr>
</table>

(*) To find the interface in Linux, you can use the command ```ifconfig```.


There is also a configuration file **slips.conf** where the user can set up parameters for Slips execution and models separately. Configuration of the **slips.conf** is described [here](#modifying-a-configuration-file).

## Reading the output
The output process collects output from the modules and handles the display of information on screen. Currently, Slips' analysis and detected malicious behaviour can be analyzed as following:

- **Kalipso** - Node.JS based graphical user interface in the terminal. Kalipso displays Slips detection and analysis in colorful table and graphs, highlighting important detections. See section Kalipso for more explanation.
- **alerts.json and alerts.txt in the output folder** - collects all evidences and detections generated by Slips in a .txt and .json formats.
- **log files in a folder _current-date-time_** - separates the traffic into files according to a profile and timewindow and summarize the traffic according to each profile and timewindow.

There are two options how to run Kalipso Locally:
1. You can run Kalipso as a shell script in another terminal using the command:

	```./kalipso.sh```
2. Use the argument ```-G```  when execting Slips. Example:

	``` ./slips.py -c slips.conf -i wlp3s0 -G ```

In docker, you can use ```-G``` or open a new terminal inside the slips container and execute ```./kalipso.sh```

To open a new terminal inside Slips container first [run](https://stratospherelinuxips.readthedocs.io/en/develop/installation.html#running-slips-inside-a-docker-from-the-dockerhub) Slips in one terminal

Now in a new local terminal get the Slips container ID:

```docker ps```

Create another terminal of the Slips container using 

```docker exec -it <container_id> bash```

Now you can run 

```./kalipso.sh```

## Saving the database

Slips uses redis to store analysis information. you can save your analysis for later use by running slips with ```-s```, for example

```./slips.py -f dataset/hide-and-seek-short.pcap -s```

Your .rdb saved database will be stored in ```redis_backups/```.

You can load it again using ```-d```, For example:

```./slips.py -d redis_backups/hide-and-seek-short.rdb ```

And then use ```./kalipso``` to view the loaded database.

This feature isn't supported in docker due to problems with redis on docker.


## Modifying a configuration file

Slips has a ```slips.conf``` the contains user configurations for different modules and general execution. Below are some of Slips features that can be modifie with respect to the user preferences.

### Generic configuration

**Time window width.**

Each IP address that appears in the network traffic of the input is represented as a profile in Slips. Each profile is divided into time windows. Each time window is 1 hour long by default, and it gathers the network traffic and its behaviour for the period of 1 hour. The duration of the timewindow can be changed in the the slips.conf using

```time_window_width```

**Home Network**

Slips needs to know your home network to be able to use specific zeek scripts. 

If ```home_network``` is not defined, Slips uses all ranges ```'92.168.0.0/16, 172.16.0.0/12, 10.0.0.0/8``` as your local network.


**Analysis Direction**


```analysis_direction``` can either be ```out``` or ```all```

<div class="zoom">
<img style="max-width:500px;max-height:500px;" src="https://raw.githubusercontent.com/stratosphereips/StratosphereLinuxIPS/develop/docs/images/directions.png" title="Figure 1. Out and all directions">
</div>


### Disabling a module

You can disable modules easily by appending the module name to the ```disable``` list.

### ML Detection

The ```mode=train``` should be used to tell the MLdetection1 module that the flows received are all for training.

The ```mode=test``` should be used after training the models, to test unknown data. 

You should have trained at least once with 'Normal' data and once with 'Malicious' data in order for the test to work.

### Blocking

This module is enabled only using the ```-p``` parameter and needs an interface to run. 

Usage example:

```sudo ./slips.py -i wlp3s0 -p```

Slips needs to be run as root so it can execute iptables commands. 

In Docker, since there's no root, the environment variable ```IS_IN_A_DOCKER_CONTAINER``` should be set to ```True``` to use 'sudo' properly.

If you use the latest Dockerfile, it will be set by default. If not, you can set it manually by running this command in the docker container

```export IS_IN_A_DOCKER_CONTAINER=True```




### VirusTotal

In order for virustotal module to work, you need to add your VirusTotal API key to the file
```modules/virustotal/api_key_secret```.

You can specify the path to the file with VirusTotal API key in the ```api_key_file``` variable.

The file should contain the key at the start of the first line, and nothing more.

If no key is found, virustotal module will not start.

### Threat Intelligence
The threat intelligence module reads IoCs from local and remote files. 

**Remote files**

We update the remote ones regularly. The list of remote threat intelligence files is set in the variables ```ti_files``` variable in slips.conf. You can add your own remote threat intelligence feeds in this variable. Supported extensions are: .txt, .csv, .netset, ipsum feeds, or .intel.

Each URL should be added with a confidence and a tag, the format is (url,confidence,tag) 

tag is which category is this feed e.g. phishing, adtrackers, etc..

confidence is on a scale from 0 to 1 how confident are you that this feed has valid IOCs.

The lower the confidence the less likely it is for Slips to alert when a malicious IP/domain is found in this feed.

Be sure the format is correct and only use spaces to separate between tuples and not between urls and confidence.

The remote files are installed to the path set in the ```download_path_for_local_threat_intelligence```. By default, the files are stored in the Slips directory ```modules/ThreatIntelligence1/remote_data_files/``` 

**RiskIQ feeds**

Slips supports getting phishing domains from RiskIQ.

You can add your your email in the configuration file in the ```RiskIQ_email``` parameter

The path of the API key is specified in the ```RiskIQ_key_path``` parameter, 
in that file there should only be the 64 character RiskIQ API key.

**Local files**

You can insert your files into the folder specified in the variable ```download_path_for_remote_threat_intelligence```. You can also hardcode your own malicious IPs in the file```modules/ThreatIntelligence1/local_data_files/own_malicious_ips.csv```

### Flowalerts

Slips needs a threshold to determine a connection of a long duration. By default, it is 1500 seconds, and it can be changed in the variable ```long_connection_threshold```

### Exporting Alerts

Slips can export alerts to Slack and STIX.

To specify where to export, you can append the ```export_to``` list. 

**To export to Slack**

You need to add your Slack bot token to the file ```modules/ExportingAlerts/slack_bot_token_secret```. The file should contain the token at the start of the first line, and nothing more.

If you do not have a Slack bot, follow steps 1 to 3 [here](https://api.slack.com/bot-users#creating-bot-user) to get one.

You can specify the channel name to send alerts to in the ```slack_channel_name``` variable, and the sensor name to be sent together with the alert in the ```sensor_name``` variable.

**To export to STIX**

If you want to export alerts using Stix, change ```export_to``` variable to export to STIX, and Slips will automatically generate a 
```STIX_data.json``` containing all alerts it detects.

You can add your TAXII server details in the following variables:

```TAXII_server```: link to your TAXII server

```port```: port to be used

```use_https```: use https or not.

```discovery_path``` and ```inbox_path``` should contain URIs not full urls. For example:

```python
discovery_path = /services/discovery-a
inbox_path = /services/inbox-a
```

```collection_name```: the collection on the server you want to push your STIX data to.

```push_delay```: the time to wait before pushing STIX data to server (in seconds). It is used when slips is running non-stop (e.g with -i )

```taxii_username```: TAXII server user credentials

```taxii_password```: TAXII server user password

```jwt_auth_url```: auth url if JWT based authentication is used.

If running on a file not an interface, Slips will export to server after analysis is done. 

## Logging

To disable the creation of log files, there are two options:
1. Running Slips with ```-l``` flag. 
2. Setting ```create_log_files``` to ```no``` in ```slips.conf```.

You can also change how often Slips creates log files using the ```log_report_time``` variable  in ```slips.conf```.

We use two variables for logging, ```verbose``` and ```debug```, they both range from 0 to 3.

Defaut value for both of them is 1

To change them, We use ```-v``` for verbosity and ```-e``` for debugging

For example:

```./slips.py -c slips.conf -v 2 -e 1 -f zeek_dir ```

Verbosity is about less or more information on the normal work of slips. 

For example: "Done writing logs to file x."

Debug is only about errors.

For example: "Error reading threat intelligence file, line 4, column 2"

To more verbosity level, the more detailed info is printed.

The more debug level, the more errors are logged.

Below is a table showing each level of both.

<table>
<tbody>
<tr style="height: 22px;">
<td style="height: 22px;">&nbsp;</td>
<td style="height: 22px;">&nbsp;Verbosity</td>
<td style="height: 22px;">&nbsp;Debugging</td>
</tr>
<tr style="height: 22px;">
<td style="height: 22px;">&nbsp;0</td>
<td style="height: 22px;">&nbsp;Don't&nbsp;print</td>
<td style="height: 22px;">&nbsp;Don't print</td>
</tr>
<tr style="height: 22px;">
<td style="height: 22px;">1&nbsp;</td>
<td style="height: 22px;">&nbsp;Show basic operation, proof of work&nbsp;</td>
<td style="height: 22px;">&nbsp;Print exceptions</td>
</tr>
<tr style="height: 22px;">
<td style="height: 22px;">2&nbsp;</td>
<td style="height: 22px;">&nbsp;Log I/O operations and filenames</td>
<td style="height: 22px;">&nbsp;Unsupported and unhandled types (cases that may cause errors)</td>
</tr>
<tr style="height: 22px;">
<td style="height: 22px;">3&nbsp;</td>
<td style="height: 22px;">&nbsp;Log database/profile/timewindow changes</td>
<td style="height: 22px;">&nbsp;Red warnings that need examination - developer warnings</td>
</tr>
</tbody>
</table>



# Unit testing
To test your changes to Slips, please run all the unit tests. Fromn the main folder where slips is installed:

    python3 tests/run_all_tests.py

### Plug in a zeek script

Slips supports automatically running a custom zeek script by adding it to ```zeek-scripts``` dir.


## Running Slips from python

You can run Slips from python using the following script

```py
import subprocess
command = './slips.py -f dataset/test3.binetflow -o /data/test'
args = command.split()
process = subprocess.run(args, stdout=subprocess.PIPE)
```